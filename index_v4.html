<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCR –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞–∫–∞–∑–æ–≤ -> Excel v4.0 Enterprise</title>
  <style>
    :root { --accent:#2563eb; --border:#e5e7eb; --muted:#6b7280; --success:#16a34a; --warning:#f59e0b; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color:#111827; background:#f9fafb; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    .version { color: var(--accent); font-size: 12px; font-weight: 600; background:#dbeafe; padding:2px 8px; border-radius:12px; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; background:#fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .spacer { flex:1; }
    .btn { padding:10px 14px; border:1px solid #374151; background:#fff; border-radius:10px; cursor:pointer; font-size:14px; transition: all 0.2s; }
    .btn:hover:not(:disabled) { background:#f3f4f6; transform: translateY(-1px); }
    .btn:disabled { opacity:.5; cursor:default; }
    .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn.success { background:var(--success); color:#fff; border-color:var(--success); }
    .btn.secondary { border-color:var(--border); }
    .drop { border:2px dashed #9ca3af; border-radius:12px; padding:18px; text-align:center; color:#374151; }
    .drop.dragover { border-color: var(--accent); background:#eef2ff; color:#1d4ed8; }
    .muted { color: var(--muted); font-size: 14px; }
    .status { font-size: 13px; margin-left: 8px; }
    .progress { height: 8px; background:#f3f4f6; border-radius:6px; overflow:hidden; margin-top:8px; }
    .bar { height:100%; width:0%; background:var(--accent); transition:width .18s ease; }
    .progress-label { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .container { display: flex; gap: 16px; }
    .main-panel { flex: 1; min-width: 0; }
    .side-panel { width: 360px; border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: #fafafa; position: sticky; top: 24px; height: fit-content; max-height: calc(100vh - 48px); overflow: auto; }
    .side-panel.hidden { display: none; }

    .virtual-container { overflow: auto; max-height: 420px; border:1px solid var(--border); border-radius:8px; position: relative; }
    .virtual-spacer { height: 0; }
    .virtual-content { position: relative; }

    .grid { width:100%; border-collapse:collapse; table-layout:fixed; }
    .grid th, .grid td { border:1px solid #f3f4f6; padding:6px 8px; font-size:12px; vertical-align:top; word-wrap: break-word; }
    .grid th { background:#fafafa; text-align:left; position:sticky; top:0; z-index:2; font-weight:600; }
    .grid tr:hover { background: #f9fafb; cursor: pointer; }
    .grid tr.selected { background: #dbeafe; }
    .grid tr.priority { border-left: 3px solid var(--accent); }
    .grid tr.duplicate { background: #fef3c7; }
    td[contenteditable="true"] { background:#fff; outline:none; }
    td[contenteditable="true"]:focus { box-shadow: inset 0 0 0 2px rgba(37,99,235,.2); }

    .tabs { display:flex; gap:4px; border-bottom:2px solid var(--border); margin-bottom:12px; }
    .tab { padding:8px 16px; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; font-weight:500; color:var(--muted); }
    .tab.active { border-bottom-color:var(--accent); color:var(--accent); }
    .tab:hover { background:#f3f4f6; }

    .tools { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .select { padding:8px 10px; border:1px solid #9ca3af; border-radius:10px; background:#fff; font-size:13px; }
    .input { padding:8px 10px; border:1px solid #9ca3af; border-radius:10px; background:#fff; font-size:13px; }
    .small { font-size:12px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:8px; max-height:110px; overflow:auto; font-size: 11px; }

    .preview-img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border); }
    .preview-title { font-weight: 600; margin-bottom: 8px; color: #111827; font-size:16px; }
    .preview-data { font-size: 12px; margin-top: 12px; }
    .preview-data dt { font-weight: 600; margin-top: 8px; color: #6b7280; }
    .preview-data dd { margin: 4px 0 0 0; color: #111827; word-break: break-word; }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 4px; }
    .badge.corrected { background: #dcfce7; color: #166534; }
    .badge.warning { background: #fef3c7; color: #92400e; }
    .badge.cached { background: #e0e7ff; color: #3730a3; }
    .badge.duplicate { background: #fed7aa; color: #9a3412; }

    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
    .stat-card { background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:12px; }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .stat-value { font-size: 20px; font-weight: 700; color: #111827; margin-top: 4px; }

    .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
    .modal.active { display:flex; }
    .modal-content { background:#fff; border-radius:12px; max-width:600px; width:90%; max-height:80vh; overflow:auto; padding:24px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { font-size:18px; font-weight:600; margin-bottom:16px; }
    .modal-body { margin-bottom:16px; }
    .modal-footer { display:flex; gap:8px; justify-content:flex-end; }

    .form-group { margin-bottom: 16px; }
    .form-label { display:block; font-weight:600; margin-bottom:4px; font-size:13px; }
    .form-control { width:100%; padding:8px 12px; border:1px solid #9ca3af; border-radius:8px; font-size:14px; }
    .form-control:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
    textarea.form-control { min-height:100px; font-family:monospace; resize:vertical; }

    .template-list { display:flex; flex-direction:column; gap:8px; }
    .template-item { display:flex; align-items:center; gap:8px; padding:8px; border:1px solid var(--border); border-radius:8px; background:#f9fafb; }
    .template-item.active { border-color:var(--accent); background:#dbeafe; }
    .template-name { flex:1; font-weight:500; }

    .analytics-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .analytics-section { background:#f9fafb; padding:12px; border-radius:8px; border:1px solid var(--border); }
    .analytics-title { font-weight:600; margin-bottom:8px; font-size:14px; }
    .analytics-list { font-size:12px; }
    .analytics-list-item { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid var(--border); }

    .history-item { padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; cursor:pointer; background:#fff; }
    .history-item:hover { background:#f9fafb; border-color:var(--accent); }
    .history-title { font-weight:600; font-size:14px; }
    .history-meta { font-size:11px; color:var(--muted); margin-top:4px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>OCR –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞–∫–∞–∑–æ–≤ -> Excel <span class="version">v4.0 Enterprise</span></h1>

  <div class="card">
    <div class="row">
      <label class="btn">
        üìÅ –§–∞–π–ª—ã
        <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
      </label>
      <label class="btn">
        üìÇ –ü–∞–ø–∫–∞
        <input id="dirInput" type="file" webkitdirectory style="display:none" />
      </label>
      <button id="runBtn" class="btn primary" disabled>üöÄ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button>
      <button id="reparseBtn" class="btn secondary" disabled>üîÑ –ü–µ—Ä–µ–ø–∞—Ä—Å–∏—Ç—å</button>
      <button id="cancelBtn" class="btn secondary" disabled>‚èπ –û—Ç–º–µ–Ω–∞</button>
      <button id="dedupeBtn" class="btn secondary" disabled>üîó –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è</button>
      <button id="saveBtn" class="btn success" disabled>üíæ Excel</button>
      <button id="exportMenuBtn" class="btn secondary" disabled>üì§ –≠–∫—Å–ø–æ—Ä—Ç ‚ñæ</button>
      <span class="spacer"></span>
      <button id="templatesBtn" class="btn secondary">üìã –®–∞–±–ª–æ–Ω—ã</button>
      <button id="historyBtn" class="btn secondary">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
      <button id="analyticsBtn" class="btn secondary" disabled>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <div id="exportMenu" class="tools" style="display:none; margin-top:12px; padding:12px; background:#f9fafb; border-radius:8px;">
      <button id="exportCsvBtn" class="btn secondary">üìÑ CSV</button>
      <button id="exportJsonBtn" class="btn secondary">üìã JSON</button>
      <label class="muted">–ö–æ–¥–∏—Ä–æ–≤–∫–∞:
        <select id="csvEncoding" class="select">
          <option value="utf-8">UTF-8</option>
          <option value="windows-1251">Windows-1251</option>
        </select>
      </label>
      <label class="muted">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å:
        <select id="csvDelimiter" class="select">
          <option value=",">–ó–∞–ø—è—Ç–∞—è (,)</option>
          <option value=";">–¢–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π (;)</option>
          <option value="\t">–¢–∞–±—É–ª—è—Ü–∏—è</option>
        </select>
      </label>
    </div>

    <div id="dropZone" class="drop" style="margin-top:12px;">
      –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã/–ø–∞–ø–∫—É, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å"
      <div class="progress"><div id="progBar" class="bar"></div></div>
      <div class="progress-label" id="progressLabel"></div>
      <div id="status" class="status muted"></div>
    </div>

    <div class="stats" id="statsGrid">
      <div class="stat-card"><div class="stat-label">–ó–∞–≥—Ä—É–∂–µ–Ω–æ</div><div class="stat-value" id="statFiles">0</div></div>
      <div class="stat-card"><div class="stat-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div><div class="stat-value" id="statProcessed">0</div></div>
      <div class="stat-card"><div class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</div><div class="stat-value" id="statSpeed">0 —Ñ/–º</div></div>
      <div class="stat-card"><div class="stat-label">–ü–∞–º—è—Ç—å</div><div class="stat-value" id="statMemory">0 –ú–ë</div></div>
      <div class="stat-card"><div class="stat-label">–î—É–±–ª–∏–∫–∞—Ç—ã</div><div class="stat-value" id="statDupes">0</div></div>
    </div>

    <div class="small muted" style="margin-top:12px;">
      üè¢ v4.0 Enterprise: —à–∞–±–ª–æ–Ω—ã –ø–∞—Ä—Å–∏–Ω–≥–∞, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —ç–∫—Å–ø–æ—Ä—Ç CSV/JSON, –∏—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π
    </div>
  </div>

  <div class="container">
    <div class="main-panel">
      <div class="card">
        <div class="row" style="justify-content: space-between">
          <div class="muted">–î–∞–Ω–Ω—ã–µ (<span id="rowCount">0</span> —Å—Ç—Ä–æ–∫, <span id="dupeCount">0</span> –¥—É–±–ª–∏–∫–∞—Ç–æ–≤):</div>
          <div class="tools">
            <label class="muted">–°—Ç–æ–ª–±–µ—Ü:
              <select id="colSelect" class="select">
                <option>–§–∞–π–ª</option><option selected>–§–ò–û</option><option>–¢–µ–ª–µ—Ñ–æ–Ω</option>
                <option>–†–µ–≥–∏–æ–Ω</option><option>–ì–æ—Ä–æ–¥</option><option>–£–ª–∏—Ü–∞</option><option>–î–æ–º/–ö–≤</option>
                <option>–ê–¥—Ä–µ—Å (–ø–æ–ª–Ω—ã–π)</option><option>Raw OCR</option>
              </select>
            </label>
            <button id="clearColBtn" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button id="fillDownBtn" class="btn secondary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–∏–∑</button>
          </div>
        </div>
        <div id="virtualContainer" class="virtual-container">
          <div id="virtualSpacer" class="virtual-spacer"></div>
          <div id="virtualContent" class="virtual-content">
            <table id="preview" class="grid">
              <thead><tr>
                <th style="width:120px">–§–∞–π–ª</th><th style="width:160px">–§–ò–û</th><th style="width:130px">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th style="width:110px">–†–µ–≥–∏–æ–Ω</th><th style="width:100px">–ì–æ—Ä–æ–¥</th><th style="width:150px">–£–ª–∏—Ü–∞</th>
                <th style="width:90px">–î–æ–º/–ö–≤</th><th style="width:200px">–ê–¥—Ä–µ—Å (–ø–æ–ª–Ω—ã–π)</th><th style="width:200px">Raw OCR</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">–õ–æ–≥–∏:</div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <div id="sidePanel" class="side-panel hidden">
      <div class="tabs">
        <div class="tab active" data-tab="preview">–ü—Ä–µ–≤—å—é</div>
        <div class="tab" data-tab="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      </div>
      <div id="previewTab" class="tab-content">
        <div class="preview-title">–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–æ—á–∫–∏</div>
        <img id="previewImg" class="preview-img" alt="Preview" />
        <dl class="preview-data" id="previewData"></dl>
      </div>
      <div id="analyticsTab" class="tab-content" style="display:none;">
        <div class="preview-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div id="analyticsContent"></div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
  <div id="templatesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üìã –®–∞–±–ª–æ–Ω—ã –ø–∞—Ä—Å–∏–Ω–≥–∞</div>
      <div class="modal-body">
        <div class="template-list" id="templateList"></div>
        <div style="margin-top:16px;">
          <button id="addTemplateBtn" class="btn primary">‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
          <button id="importTemplateBtn" class="btn secondary">üì• –ò–º–ø–æ—Ä—Ç</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="closeTemplatesBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="templateEditorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞</div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
          <input type="text" id="templateName" class="form-control" placeholder="Wildberries, Ozon, –∏ —Ç.–¥." />
        </div>
        <div class="form-group">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input type="text" id="templateDesc" class="form-control" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" />
        </div>
        <div class="form-group">
          <label class="form-label">JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</label>
          <textarea id="templateJson" class="form-control" placeholder='{"fio": {"lineIndex": 0}, "phone": {"lineIndex": 2}}'></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="saveTemplateBtn" class="btn primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="cancelTemplateBtn" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üìú –ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</div>
      <div class="modal-body">
        <div id="historyList"></div>
      </div>
      <div class="modal-footer">
        <button id="exportSessionBtn" class="btn secondary">üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—É—â–µ–π</button>
        <button id="importSessionBtn" class="btn secondary">üì• –ò–º–ø–æ—Ä—Ç</button>
        <button id="closeHistoryBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="analyticsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      <div class="modal-body" id="analyticsModalContent"></div>
      <div class="modal-footer">
        <button id="closeAnalyticsBtn" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================== CORE =========================================================== */
const COLS = ["–§–∞–π–ª","–§–ò–û","–¢–µ–ª–µ—Ñ–æ–Ω","–†–µ–≥–∏–æ–Ω","–ì–æ—Ä–æ–¥","–£–ª–∏—Ü–∞","–î–æ–º/–ö–≤","–ê–¥—Ä–µ—Å (–ø–æ–ª–Ω—ã–π)","Raw OCR"];
let filesList = [], rows = [], processedBlobs = new Map(), cancelFlag = false, currentTemplate = null;

/* =========================================================== INDEXEDDB =========================================================== */
class DB {
  constructor(name, stores) { this.name = name; this.stores = stores; this.db = null; }
  async init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.name, 2);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => { this.db = req.result; resolve(); };
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        this.stores.forEach(store => {
          if (!db.objectStoreNames.contains(store)) db.createObjectStore(store, {keyPath: 'id', autoIncrement: true});
        });
      };
    });
  }
  async get(store, id) {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readonly');
      const req = tx.objectStore(store).get(id);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async getAll(store) {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readonly');
      const req = tx.objectStore(store).getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async add(store, data) {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readwrite');
      const req = tx.objectStore(store).add(data);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async put(store, data) {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readwrite');
      const req = tx.objectStore(store).put(data);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async delete(store, id) {
    if (!this.db) await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readwrite');
      const req = tx.objectStore(store).delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }
}

const db = new DB('OCR_Enterprise_v4', ['templates', 'sessions', 'tessdata']);

/* =========================================================== –°–õ–û–í–ê–†–ò (v2.0) =========================================================== */
const SURNAMES=new Set(["–ò–≤–∞–Ω–æ–≤","–°–º–∏—Ä–Ω–æ–≤","–ö—É–∑–Ω–µ—Ü–æ–≤","–ü–æ–ø–æ–≤","–í–∞—Å–∏–ª—å–µ–≤","–ü–µ—Ç—Ä–æ–≤","–°–æ–∫–æ–ª–æ–≤","–ú–∏—Ö–∞–π–ª–æ–≤","–ù–æ–≤–∏–∫–æ–≤","–§—ë–¥–æ—Ä–æ–≤","–ú–æ—Ä–æ–∑–æ–≤","–í–æ–ª–∫–æ–≤","–ê–ª–µ–∫—Å–µ–µ–≤","–õ–µ–±–µ–¥–µ–≤","–°–µ–º—ë–Ω–æ–≤","–ï–≥–æ—Ä–æ–≤","–ü–∞–≤–ª–æ–≤","–ö–æ–∑–ª–æ–≤","–°—Ç–µ–ø–∞–Ω–æ–≤","–ù–∏–∫–æ–ª–∞–µ–≤","–û—Ä–ª–æ–≤","–ê–Ω–¥—Ä–µ–µ–≤","–ú–∞–∫–∞—Ä–æ–≤","–ù–∏–∫–∏—Ç–∏–Ω","–ó–∞—Ö–∞—Ä–æ–≤","–ó–∞–π—Ü–µ–≤"]);
const NAMES=new Set(["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä","–ê–ª–µ–∫—Å–µ–π","–ê–Ω–¥—Ä–µ–π","–ê–Ω—Ç–æ–Ω","–ê—Ä—Ç—ë–º","–ë–æ—Ä–∏—Å","–í–∞–¥–∏–º","–í–ª–∞–¥–∏–º–∏—Ä","–î–º–∏—Ç—Ä–∏–π","–ï–≤–≥–µ–Ω–∏–π","–ï–≥–æ—Ä","–ò–≤–∞–Ω","–ò–≥–æ—Ä—å","–ò–ª—å—è","–ö–∏—Ä–∏–ª–ª","–ú–∞–∫—Å–∏–º","–ú–∏—Ö–∞–∏–ª","–ù–∏–∫–∏—Ç–∞","–û–ª–µ–≥","–ü–∞–≤–µ–ª","–†–æ–º–∞–Ω","–°–µ—Ä–≥–µ–π","–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞","–ê–Ω–∞—Å—Ç–∞—Å–∏—è","–ê–Ω–Ω–∞","–í–∞–ª–µ—Ä–∏—è","–í–∏–∫—Ç–æ—Ä–∏—è","–î–∞—Ä—å—è","–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞","–ï–ª–µ–Ω–∞","–ò—Ä–∏–Ω–∞","–ö—Å–µ–Ω–∏—è","–ú–∞—Ä–∏—è","–ù–∞—Ç–∞–ª—å—è","–û–ª—å–≥–∞","–ü–æ–ª–∏–Ω–∞","–°–≤–µ—Ç–ª–∞–Ω–∞","–¢–∞—Ç—å—è–Ω–∞"]);
const STREETS=new Set(["–õ–µ–Ω–∏–Ω–∞","–°–æ–≤–µ—Ç—Å–∫–∞—è","–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è","–®–∫–æ–ª—å–Ω–∞—è","–ú–æ–ª–æ–¥—ë–∂–Ω–∞—è","–°–∞–¥–æ–≤–∞—è","–ù–∞–±–µ—Ä–µ–∂–Ω–∞—è","–ú–∏—Ä–∞","–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è","–û–∫—Ç—è–±—Ä—å—Å–∫–∞—è","–ü–æ–±–µ–¥—ã","–°—Ç—Ä–æ–∏—Ç–µ–ª–µ–π","–ö–∏—Ä–æ–≤–∞","–ì–∞–≥–∞—Ä–∏–Ω–∞","–°–æ–ª–Ω–µ—á–Ω–∞—è","–ü–∞—Ä–∫–æ–≤–∞—è","–ü—É—à–∫–∏–Ω–∞","–ú–æ—Å–∫–æ–≤—Å–∫–∞—è","–ì–æ—Ä—å–∫–æ–≥–æ"]);

function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++)m[i]=[i];for(let j=0;j<=a.length;j++)m[0][j]=j;for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){m[i][j]=b.charAt(i-1)===a.charAt(j-1)?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);}}return m[b.length][a.length];}
function findClosest(word,dict,maxDist=2){if(!word||word.length<3)return null;const lower=word.toLowerCase();for(const e of dict)if(e.toLowerCase()===lower)return null;let best=null,bestD=maxDist+1;for(const e of dict){const d=levenshtein(lower,e.toLowerCase());if(d>0&&d<bestD){bestD=d;best=e;}}return bestD<=maxDist?best:null;}
function correctWord(word,type="surname"){const dict=type==="surname"?SURNAMES:type==="name"?NAMES:STREETS;return findClosest(word,dict)||word;}

/* =========================================================== UI =========================================================== */
const els = {
  fileInput: document.getElementById("fileInput"),
  dirInput: document.getElementById("dirInput"),
  runBtn: document.getElementById("runBtn"),
  reparseBtn: document.getElementById("reparseBtn"),
  cancelBtn: document.getElementById("cancelBtn"),
  dedupeBtn: document.getElementById("dedupeBtn"),
  saveBtn: document.getElementById("saveBtn"),
  exportMenuBtn: document.getElementById("exportMenuBtn"),
  exportMenu: document.getElementById("exportMenu"),
  templatesBtn: document.getElementById("templatesBtn"),
  historyBtn: document.getElementById("historyBtn"),
  analyticsBtn: document.getElementById("analyticsBtn"),
  previewBody: document.querySelector("#preview tbody"),
  virtualContainer: document.getElementById("virtualContainer"),
  virtualSpacer: document.getElementById("virtualSpacer"),
  sidePanel: document.getElementById("sidePanel"),
  log: document.getElementById("log"),
  status: document.getElementById("status"),
  progressLabel: document.getElementById("progressLabel"),
  progBar: document.getElementById("progBar"),
  rowCount: document.getElementById("rowCount"),
  dupeCount: document.getElementById("dupeCount"),
  statFiles: document.getElementById("statFiles"),
  statProcessed: document.getElementById("statProcessed"),
  statSpeed: document.getElementById("statSpeed"),
  statMemory: document.getElementById("statMemory"),
  statDupes: document.getElementById("statDupes"),
  previewImg: document.getElementById("previewImg"),
  previewData: document.getElementById("previewData")
};

function log(msg){const t=new Date().toLocaleTimeString();els.log.textContent+=`[${t}] ${msg}\n`;els.log.scrollTop=els.log.scrollHeight;}
function setStatus(msg){els.status.textContent=msg||"";}
function setProgressLabel(msg){els.progressLabel.textContent=msg||"";}
function prog(pct){els.progBar.style.width=Math.max(0,Math.min(100,pct))+"%";}

function updateStats(){
  els.statFiles.textContent=filesList.length;
  els.statProcessed.textContent=rows.length;
  els.rowCount.textContent=rows.length;
  const dupes=rows.filter(r=>r._duplicate).length;
  els.statDupes.textContent=dupes;
  els.dupeCount.textContent=dupes;
  if(performance.memory){
    const used=(performance.memory.usedJSHeapSize/1048576).toFixed(1);
    els.statMemory.textContent=`${used} –ú–ë`;
  }
}

els.exportMenuBtn.addEventListener("click",()=>{els.exportMenu.style.display=els.exportMenu.style.display==="none"?"flex":"none";});

/* =========================================================== TABS =========================================================== */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const tabName=tab.dataset.tab;
    document.getElementById('previewTab').style.display=tabName==='preview'?'block':'none';
    document.getElementById('analyticsTab').style.display=tabName==='analytics'?'block':'none';
  });
});

/* =========================================================== –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –°–ö–†–û–õ–õ =========================================================== */
const ROW_HEIGHT=32,BUFFER_SIZE=10;
let visibleStart=0,visibleEnd=0;

function renderVirtualTable(){
  const h=els.virtualContainer.clientHeight||420;
  const total=rows.length*ROW_HEIGHT;
  els.virtualSpacer.style.height=`${total}px`;
  const st=els.virtualContainer.scrollTop;
  visibleStart=Math.max(0,Math.floor(st/ROW_HEIGHT)-BUFFER_SIZE);
  visibleEnd=Math.min(rows.length,Math.ceil((st+h)/ROW_HEIGHT)+BUFFER_SIZE);
  els.previewBody.innerHTML="";

  for(let i=visibleStart;i<visibleEnd;i++){
    const row=rows[i];
    if(!row)continue;
    const tr=document.createElement("tr");
    tr.style.position="absolute";
    tr.style.top=`${i*ROW_HEIGHT}px`;
    tr.style.width="100%";
    tr.dataset.index=i;
    if(i<5)tr.classList.add("priority");
    if(row._duplicate)tr.classList.add("duplicate");

    COLS.forEach((k,idx)=>{
      const td=document.createElement("td");
      td.textContent=row[k]??"";
      if(idx!==0)td.setAttribute("contenteditable","true");
      td.addEventListener("dblclick",()=>td.focus());
      tr.appendChild(td);
    });

    tr.addEventListener("click",(e)=>{
      if(e.target.tagName!=="TD"||!e.target.hasAttribute("contenteditable"))showPreview(i);
    });

    els.previewBody.appendChild(tr);
  }

  updateStats();
}

els.virtualContainer.addEventListener("scroll",()=>requestAnimationFrame(renderVirtualTable));

function addRowToTable(row){
  rows.push(row);
  if(rows.length<=visibleEnd)renderVirtualTable();
}

/* =========================================================== –ü–†–ï–î–û–ë–†–ê–ë–û–¢–ö–ê =========================================================== */
async function fileToImageBitmap(file){const u=URL.createObjectURL(file);const img=await createImageBitmap(await(await fetch(u)).blob());URL.revokeObjectURL(u);return img;}

function getExifOrientation(buf){try{const v=new DataView(buf);if(v.getUint16(0,false)!==0xFFD8)return 1;let o=2;while(o<v.byteLength){const m=v.getUint16(o,false);o+=2;if(m===0xFFE1){o+=2;if(v.getUint32(o,false)!==0x45786966)return 1;o+=6;const l=v.getUint16(o,false)===0x4949;o+=2;if(v.getUint16(o,l)!==0x002A)return 1;o+=2;let d=v.getUint32(o,l);o=o-4+d;const n=v.getUint16(o,l);o+=2;for(let i=0;i<n;i++){const t=v.getUint16(o+i*12,l);if(t===0x0112)return v.getUint16(o+i*12+8,l)||1;}return 1;}else{const len=v.getUint16(o,false);o+=len;}}}catch(e){}return 1;}

function drawWithOrientation(ctx,img,w,h,o){switch(o){case 2:ctx.translate(w,0);ctx.scale(-1,1);break;case 3:ctx.translate(w,h);ctx.rotate(Math.PI);break;case 4:ctx.translate(0,h);ctx.scale(1,-1);break;case 6:ctx.rotate(0.5*Math.PI);ctx.translate(0,-h);break;case 8:ctx.rotate(-0.5*Math.PI);ctx.translate(-w,0);break;}ctx.drawImage(img,0,0,w,h);}

async function preprocessToBlob(file){
  const ab=await file.arrayBuffer();
  const o=getExifOrientation(ab)||1;
  const img=await fileToImageBitmap(new File([ab],file.name,{type:file.type}));
  const targetW=1800,scale=targetW/img.width,W=Math.round(img.width*scale),H=Math.round(img.height*scale);
  const rot90=[5,6,7,8].includes(o),cw=rot90?H:W,ch=rot90?W:H;
  const cvs=new OffscreenCanvas(cw,ch),ctx=cvs.getContext("2d",{willReadFrequently:true});
  ctx.save();drawWithOrientation(ctx,img,W,H,o);ctx.restore();

  let imgData=ctx.getImageData(0,0,cw,ch);
  const d=imgData.data,hist=new Uint32Array(256);
  for(let i=0;i<d.length;i+=4){const y=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;d[i]=d[i+1]=d[i+2]=y;d[i+3]=255;hist[y]++;}

  function percentile(p){const tgt=p*(cw*ch);let acc=0;for(let i=0;i<256;i++){acc+=hist[i];if(acc>=tgt)return i;}return p===0?0:255;}
  const lo=percentile(0.02),hi=percentile(0.98),span=Math.max(1,hi-lo);
  for(let i=0;i<d.length;i+=4){let y=d[i];y=((y-lo)*255/span)|0;if(y<0)y=0;if(y>255)y=255;d[i]=d[i+1]=d[i+2]=y;}

  const hist2=new Uint32Array(256);
  for(let i=0;i<d.length;i+=4)hist2[d[i]]++;
  let sum=0,sumB=0,wB=0,wF=0,maxVar=0,thr=127;
  for(let i=0;i<256;i++)sum+=i*hist2[i];
  const total=cw*ch;
  for(let t=0;t<256;t++){wB+=hist2[t];if(wB===0)continue;wF=total-wB;if(wF===0)break;sumB+=t*hist2[t];const mB=sumB/wB,mF=(sum-sumB)/wF,between=wB*wF*(mB-mF)*(mB-mF);if(between>maxVar){maxVar=between;thr=t;}}
  for(let i=0;i<d.length;i+=4){const val=d[i]>thr?255:0;d[i]=d[i+1]=d[i+2]=val;}

  ctx.putImageData(imgData,0,0);
  return await cvs.convertToBlob({type:"image/png",quality:1});
}

/* =========================================================== –ü–ê–†–°–ò–ù–ì =========================================================== */
const PHONE_RE=/(\+7|8)\s*\(?\s*\d{3}\s*\)?\s*[-\s]?\d{3}[-\s]?\d{2}[-\s]?\d{2}/g;
function cleanNoise(t){return(t||"").replace(/[‚Ä¢‚óè‚ó¶‚àô¬∑¬©¬Æ‚Ñ¢]/g," ").replace(/—Ñ–∏–æ[:\s]*/gi," ").replace(/—Ñ–∏–∑–ª–∏—Ü–æ|mobile/gi," ").replace(/[‚Äî‚Äì]+/g,"-").replace(/[\u200E\u200F\u00A0]/g," ").replace(/\s{2,}/g," ").trim();}
function normalizePhone(r){const d=r.match(/\d/g)?.join("")||"";if(d.length<10)return r.trim();let dd=d;if(dd.length===11&&dd[0]==="8")dd="7"+dd.slice(1);if(dd.length!==11)return r.trim();return"+7 "+dd.slice(1,4)+" "+dd.slice(4,7)+"-"+dd.slice(7,9)+"-"+dd.slice(9,11);}
function parsePhones(t){const seen=new Set(),list=[];for(const m of(t||"").matchAll(PHONE_RE)){const ph=normalizePhone(m[0]),key=ph.replace(/\D/g,"");if(!seen.has(key)){seen.add(key);list.push(ph);}}return list.join(", ");}

function toCyrLookalikes(s){const map={A:"–ê",B:"–í",C:"–°",E:"–ï",H:"–ù",K:"–ö",M:"–ú",O:"–û",P:"–†",T:"–¢",X:"–•",Y:"–£",a:"–∞",b:"–≤",c:"—Å",e:"–µ",h:"–Ω",k:"–∫",m:"–º",o:"–æ",p:"—Ä",t:"—Ç",x:"—Ö",y:"—É"};return s.replace(/[ABCEHKMOPTXYabcehkmoptxy]/g,ch=>map[ch]||ch);}
function fixCyrConfusions(w){let ww=toCyrLookalikes(w);ww=ww.replace(/–®—â|–®–©/g,"–©").replace(/—à—â|—à–©/g,"—â").replace(/–ô–ò/gu,"–ò").replace(/–π–∏/gu,"–∏").replace(/–ó3/g,"–ó").replace(/–∑3/g,"–∑").replace(/^[\.\-]+|[\.\-]+$/g,"");return ww;}
function titlecaseRu(s){return s.trim().split(/\s+/).map(p=>p?p[0].toUpperCase()+p.slice(1).toLowerCase():p).join(" ");}

function parseFio(text){
  const t=cleanNoise(text);
  const tokens=t.split(/[^–ê-–Ø–∞-—è–Å—ë-]+/).map(w=>w&&fixCyrConfusions(w)).filter(w=>w&&w.length>=2);
  const stop=/^(—Ä–æ—Å—Å–∏—è|–≥–æ—Ä–æ–¥|—É–ª–∏—Ü–∞|—É–ª|–æ–±–ª–∞—Å—Ç—å|–∫—Ä–∞–π|—Ä–∞–π–æ–Ω|—Ä—Ñ|—Ä–µ–≥–∏–æ–Ω)$/i;
  for(let i=0;i<tokens.length-1;i++){
    const a=tokens[i],b=tokens[i+1],c=tokens[i+2];
    if(stop.test(a))continue;
    const aC=correctWord(a,"surname"),bC=correctWord(b,"name"),cC=c?correctWord(c,"name"):null;
    if(c&&a.length>=3&&b.length>=3&&c.length>=3)return titlecaseRu(`${aC} ${bC} ${cC}`);
    if(a.length>=3&&b.length>=3)return titlecaseRu(`${aC} ${bC}`);
  }
  return "";
}

function isPhoneish(ln){const d=(ln||"").replace(/\D/g,"");return/\+/.test(ln)||d.length>=10;}

function parseAddressComponents(text){
  const result={region:"",city:"",street:"",building:"",fullAddress:""};
  const t=(text||"").replace(/\r/g,"");
  const start=t.search(/–†–æ—Å—Å–∏—è|–†–§/i);
  if(start<0)return result;
  let tail=t.slice(start).replace(/^–†–§/i,"–†–æ—Å—Å–∏—è");
  let parts=tail.split(/\n/).map(s=>s.trim()).filter(Boolean);
  const limited=[];
  for(let i=0;i<parts.length&&i<6;i++){
    const ln=parts[i];
    if(isPhoneish(ln))continue;
    if(/—Ñ–∏–æ|mobile|–º–æ–±–∏–ª|–∑–∞–∫–∞–∑|—Ç–µ–ª–µ—Ñ|–∫–ª–∏–µ–Ω—Ç|–ø–æ–ª—É—á–∞—Ç–µ–ª/iu.test(ln))continue;
    limited.push(ln);
  }
  result.fullAddress=limited.join(", ").replace(/^–†–æ—Å—Å–∏—è(?!\s*,)/i,"–†–æ—Å—Å–∏—è,").replace(/\s*,\s*,/g,", ").replace(/\s{2,}/g," ").replace(/,\s*$/,"").trim();

  const fl=limited[0]||"";
  const regMatch=fl.match(/,\s*([^,]+?(?:–æ–±–ª–∞—Å—Ç—å|–æ–±–ª\.?|–∫—Ä–∞–π|—Ä–µ—Å–ø—É–±–ª–∏–∫–∞|—Ä–µ—Å–ø\.?))/i);
  if(regMatch)result.region=regMatch[1].trim();
  const cityMatch=fl.match(/,\s*(?:–≥\.?\s+)?([–ê-–Ø–Å][–∞-—è—ë\-\s]+?)(?=\s*,|$)/i);
  if(cityMatch){let cand=cityMatch[1].trim();if(!/–æ–±–ª–∞—Å—Ç—å|–æ–±–ª\.|–∫—Ä–∞–π|—Ä–µ—Å–ø—É–±–ª–∏–∫–∞|—Ä–µ—Å–ø\./i.test(cand))result.city=cand.replace(/^–≥\.?\s*/i,"");}

  const streetLine=limited.find(ln=>/(?:—É–ª\.?|—É–ª–∏—Ü–∞|–ø—Ä–æ—Å–ø\.?|–ø—Ä–æ—Å–ø–µ–∫—Ç|–ø–µ—Ä\.?|–ø–µ—Ä–µ—É–ª–æ–∫|—à–æ—Å—Å–µ|—à\.|–±-—Ä|–±—É–ª—å–≤–∞—Ä)/i.test(ln));
  if(streetLine){
    const stMatch=streetLine.match(/((?:—É–ª\.?|—É–ª–∏—Ü–∞|–ø—Ä–æ—Å–ø\.?|–ø—Ä–æ—Å–ø–µ–∫—Ç|–ø–µ—Ä\.?|–ø–µ—Ä–µ—É–ª–æ–∫|—à–æ—Å—Å–µ|—à\.|–±-—Ä|–±—É–ª—å–≤–∞—Ä)\s+[^,\d]+)/i);
    if(stMatch){let sn=stMatch[1].trim().replace(/^(—É–ª\.?|—É–ª–∏—Ü–∞|–ø—Ä–æ—Å–ø\.?|–ø—Ä–æ—Å–ø–µ–∫—Ç|–ø–µ—Ä\.?|–ø–µ—Ä–µ—É–ª–æ–∫)\s+/i,"");const corr=correctWord(sn,"street");if(corr!==sn)sn=corr;result.street=sn;}
    const buildMatch=streetLine.match(/(?:–¥\.?|–¥–æ–º)\s*(\d+[–∞-—è–ê-–Ø]?)(?:[,\s]+(?:–∫–≤\.?|–∫–≤–∞—Ä—Ç–∏—Ä–∞)\s*(\d+))?/i);
    if(buildMatch){const house=buildMatch[1],apt=buildMatch[2];result.building=apt?`–¥.${house}, –∫–≤.${apt}`:`–¥.${house}`;}
  }
  return result;
}

function parseOrder(raw,filename){
  const cleaned=cleanNoise(raw);
  const phone=parsePhones(cleaned);
  const fio=parseFio(cleaned);
  const addr=parseAddressComponents(cleaned);
  return {"–§–∞–π–ª":filename,"–§–ò–û":fio,"–¢–µ–ª–µ—Ñ–æ–Ω":phone,"–†–µ–≥–∏–æ–Ω":addr.region,"–ì–æ—Ä–æ–¥":addr.city,"–£–ª–∏—Ü–∞":addr.street,"–î–æ–º/–ö–≤":addr.building,"–ê–¥—Ä–µ—Å (–ø–æ–ª–Ω—ã–π)":addr.fullAddress||"","Raw OCR":raw.trim()};
}

/* =========================================================== –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø =========================================================== */
function deduplicateRows(){
  const seen=new Map();
  let dupeCount=0;
  rows.forEach(r=>{
    r._duplicate=false;
    const key=`${r["–¢–µ–ª–µ—Ñ–æ–Ω"]||""}|${r["–ì–æ—Ä–æ–¥"]||""}|${r["–£–ª–∏—Ü–∞"]||""}`.toLowerCase();
    if(key!=="||"&&seen.has(key)){r._duplicate=true;dupeCount++;}
    else seen.set(key,true);
  });
  log(`üîó –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –Ω–∞–π–¥–µ–Ω–æ ${dupeCount} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`);
  renderVirtualTable();
}

els.dedupeBtn.addEventListener("click",deduplicateRows);

/* =========================================================== –ê–ù–ê–õ–ò–¢–ò–ö–ê =========================================================== */
function generateAnalytics(){
  const cities={},regions={},errors=[];
  rows.forEach(r=>{
    const city=r["–ì–æ—Ä–æ–¥"];
    const region=r["–†–µ–≥–∏–æ–Ω"];
    if(city)cities[city]=(cities[city]||0)+1;
    if(region)regions[region]=(regions[region]||0)+1;
    if(!r["–§–ò–û"]||!r["–¢–µ–ª–µ—Ñ–æ–Ω"]||!r["–ê–¥—Ä–µ—Å (–ø–æ–ª–Ω—ã–π)"])errors.push(r["–§–∞–π–ª"]);
  });

  const topCities=Object.entries(cities).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const topRegions=Object.entries(regions).sort((a,b)=>b[1]-a[1]).slice(0,5);

  return {cities:topCities,regions:topRegions,errors:errors.slice(0,10),total:rows.length};
}

function showAnalytics(){
  const analytics=generateAnalytics();
  const content=document.getElementById('analyticsContent');
  content.innerHTML=`
    <div class="analytics-section">
      <div class="analytics-title">–¢–æ–ø-10 –≥–æ—Ä–æ–¥–æ–≤</div>
      <div class="analytics-list">
        ${analytics.cities.map(([city,count])=>`<div class="analytics-list-item"><span>${city}</span><span>${count}</span></div>`).join('')}
      </div>
    </div>
    <div class="analytics-section" style="margin-top:12px;">
      <div class="analytics-title">–¢–æ–ø-5 —Ä–µ–≥–∏–æ–Ω–æ–≤</div>
      <div class="analytics-list">
        ${analytics.regions.map(([reg,count])=>`<div class="analytics-list-item"><span>${reg}</span><span>${count}</span></div>`).join('')}
      </div>
    </div>
    <div class="analytics-section" style="margin-top:12px;">
      <div class="analytics-title">–§–∞–π–ª—ã —Å –æ—à–∏–±–∫–∞–º–∏ (${analytics.errors.length})</div>
      <div class="analytics-list" style="font-size:11px;">
        ${analytics.errors.map(f=>`<div>${f}</div>`).join('')}
      </div>
    </div>
  `;
  document.getElementById('analyticsTab').style.display='block';
  document.getElementById('previewTab').style.display='none';
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="analytics"]').classList.add('active');
  els.sidePanel.classList.remove('hidden');
}

els.analyticsBtn.addEventListener("click",showAnalytics);

function showDetailedAnalytics(){
  const analytics=generateAnalytics();
  const modal=document.getElementById('analyticsModal');
  const content=document.getElementById('analyticsModalContent');
  content.innerHTML=`
    <div class="analytics-grid">
      <div class="analytics-section">
        <div class="analytics-title">üìç –¢–æ–ø-10 –≥–æ—Ä–æ–¥–æ–≤</div>
        <div class="analytics-list">
          ${analytics.cities.map(([c,n])=>`<div class="analytics-list-item"><span>${c}</span><span><strong>${n}</strong></span></div>`).join('')}
        </div>
      </div>
      <div class="analytics-section">
        <div class="analytics-title">üó∫Ô∏è –¢–æ–ø-5 —Ä–µ–≥–∏–æ–Ω–æ–≤</div>
        <div class="analytics-list">
          ${analytics.regions.map(([r,n])=>`<div class="analytics-list-item"><span>${r}</span><span><strong>${n}</strong></span></div>`).join('')}
        </div>
      </div>
    </div>
    <div class="analytics-section" style="margin-top:16px;">
      <div class="analytics-title">‚ö†Ô∏è –§–∞–π–ª—ã —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (${analytics.errors.length})</div>
      <div class="analytics-list" style="font-size:11px; max-height:200px; overflow:auto;">
        ${analytics.errors.map(f=>`<div style="padding:2px 0;">${f}</div>`).join('')||'<div>–ù–µ—Ç –æ—à–∏–±–æ–∫</div>'}
      </div>
    </div>
  `;
  modal.classList.add('active');
}

document.getElementById('closeAnalyticsBtn').addEventListener('click',()=>{
  document.getElementById('analyticsModal').classList.remove('active');
});

/* =========================================================== –®–ê–ë–õ–û–ù–´ =========================================================== */
const defaultTemplate={name:"–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é",description:"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä—Å–µ—Ä",config:{}};

async function loadTemplates(){
  const templates=await db.getAll('templates');
  return templates.length>0?templates:[defaultTemplate];
}

async function saveTemplate(template){
  if(template.id)await db.put('templates',template);
  else await db.add('templates',template);
}

async function showTemplates(){
  const templates=await loadTemplates();
  const list=document.getElementById('templateList');
  list.innerHTML=templates.map(t=>`
    <div class="template-item ${t.id===currentTemplate?.id?'active':''}" data-id="${t.id||0}">
      <div class="template-name">${t.name}</div>
      <div style="margin-left:auto; display:flex; gap:4px;">
        <button class="btn secondary" onclick="editTemplate(${t.id||0})">‚úèÔ∏è</button>
        <button class="btn secondary" onclick="exportTemplate(${t.id||0})">üì§</button>
        ${t.id?`<button class="btn secondary" onclick="deleteTemplate(${t.id})">üóëÔ∏è</button>`:''}
      </div>
    </div>
  `).join('');
  document.getElementById('templatesModal').classList.add('active');
}

window.editTemplate=async function(id){
  const templates=await loadTemplates();
  const tpl=templates.find(t=>t.id===id)||defaultTemplate;
  document.getElementById('templateName').value=tpl.name;
  document.getElementById('templateDesc').value=tpl.description||'';
  document.getElementById('templateJson').value=JSON.stringify(tpl.config,null,2);
  document.getElementById('templateEditorModal').classList.add('active');
  document.getElementById('templateEditorModal').dataset.editId=id||'';
};

window.exportTemplate=async function(id){
  const templates=await loadTemplates();
  const tpl=templates.find(t=>t.id===id);
  if(!tpl)return;
  const blob=new Blob([JSON.stringify(tpl,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`template_${tpl.name}.json`;
  a.click();
  URL.revokeObjectURL(url);
  log(`üì§ –≠–∫—Å–ø–æ—Ä—Ç —à–∞–±–ª–æ–Ω–∞: ${tpl.name}`);
};

window.deleteTemplate=async function(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?'))return;
  await db.delete('templates',id);
  log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω —à–∞–±–ª–æ–Ω ID:${id}`);
  showTemplates();
};

els.templatesBtn.addEventListener('click',showTemplates);
document.getElementById('closeTemplatesBtn').addEventListener('click',()=>{
  document.getElementById('templatesModal').classList.remove('active');
});

document.getElementById('addTemplateBtn').addEventListener('click',()=>{
  document.getElementById('templateName').value='';
  document.getElementById('templateDesc').value='';
  document.getElementById('templateJson').value='{}';
  document.getElementById('templateEditorModal').classList.add('active');
  document.getElementById('templateEditorModal').dataset.editId='';
});

document.getElementById('saveTemplateBtn').addEventListener('click',async()=>{
  const name=document.getElementById('templateName').value.trim();
  const desc=document.getElementById('templateDesc').value.trim();
  const jsonStr=document.getElementById('templateJson').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}

  let config;
  try{config=JSON.parse(jsonStr);}catch(e){alert('–û—à–∏–±–∫–∞ JSON');return;}

  const editId=document.getElementById('templateEditorModal').dataset.editId;
  const tpl={name,description:desc,config};
  if(editId)tpl.id=parseInt(editId);

  await saveTemplate(tpl);
  log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω —à–∞–±–ª–æ–Ω: ${name}`);
  document.getElementById('templateEditorModal').classList.remove('active');
  showTemplates();
});

document.getElementById('cancelTemplateBtn').addEventListener('click',()=>{
  document.getElementById('templateEditorModal').classList.remove('active');
});

document.getElementById('importTemplateBtn').addEventListener('click',()=>{
  const input=document.createElement('input');
  input.type='file';
  input.accept='.json';
  input.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const text=await file.text();
    try{
      const tpl=JSON.parse(text);
      delete tpl.id;
      await saveTemplate(tpl);
      log(`üì• –ò–º–ø–æ—Ä—Ç —à–∞–±–ª–æ–Ω–∞: ${tpl.name}`);
      showTemplates();
    }catch(err){alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');}
  };
  input.click();
});

/* =========================================================== –ò–°–¢–û–†–ò–Ø –°–ï–°–°–ò–ô =========================================================== */
async function saveSession(){
  const session={
    timestamp:Date.now(),
    date:new Date().toLocaleString('ru-RU'),
    rows:rows,
    files:filesList.length,
    template:currentTemplate?.name||'–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é'
  };
  const id=await db.add('sessions',session);
  log(`üíæ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ID:${id}`);
  return id;
}

async function loadSession(id){
  const session=await db.get('sessions',id);
  if(!session)return;
  rows=session.rows||[];
  renderVirtualTable();
  log(`üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å–µ—Å—Å–∏—è: ${session.date}`);
  document.getElementById('historyModal').classList.remove('active');
  els.saveBtn.disabled=false;
  els.reparseBtn.disabled=false;
  els.analyticsBtn.disabled=false;
  els.dedupeBtn.disabled=false;
  els.exportMenuBtn.disabled=false;
}

async function showHistory(){
  const sessions=await db.getAll('sessions');
  const list=document.getElementById('historyList');
  if(sessions.length===0){
    list.innerHTML='<div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
  }else{
    list.innerHTML=sessions.reverse().map(s=>`
      <div class="history-item" onclick="loadSession(${s.id})">
        <div class="history-title">${s.date}</div>
        <div class="history-meta">üìÑ ${s.files} —Ñ–∞–π–ª–æ–≤ | üìä ${s.rows.length} —Å—Ç—Ä–æ–∫ | üìã ${s.template}</div>
      </div>
    `).join('');
  }
  document.getElementById('historyModal').classList.add('active');
}

window.loadSession=loadSession;

els.historyBtn.addEventListener('click',showHistory);
document.getElementById('closeHistoryBtn').addEventListener('click',()=>{
  document.getElementById('historyModal').classList.remove('active');
});

document.getElementById('exportSessionBtn').addEventListener('click',async()=>{
  const sessionId=await saveSession();
  const session=await db.get('sessions',sessionId);
  const blob=new Blob([JSON.stringify(session,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`session_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  log(`üì§ –≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Å—Å–∏–∏`);
});

document.getElementById('importSessionBtn').addEventListener('click',()=>{
  const input=document.createElement('input');
  input.type='file';
  input.accept='.json';
  input.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const text=await file.text();
    try{
      const session=JSON.parse(text);
      delete session.id;
      const id=await db.add('sessions',session);
      log(`üì• –ò–º–ø–æ—Ä—Ç —Å–µ—Å—Å–∏–∏ ID:${id}`);
      showHistory();
    }catch(err){alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');}
  };
  input.click();
});

/* =========================================================== –≠–ö–°–ü–û–†–¢ CSV/JSON =========================================================== */
function exportCSV(){
  const encoding=document.getElementById('csvEncoding').value;
  const delimiter=document.getElementById('csvDelimiter').value;
  const header=COLS.join(delimiter);
  const csvRows=[header];
  rows.forEach(r=>{
    const vals=COLS.map(k=>{
      let val=(r[k]||"").toString().replace(/"/g,'""');
      if(val.includes(delimiter)||val.includes('"')||val.includes('\n'))val=`"${val}"`;
      return val;
    });
    csvRows.push(vals.join(delimiter));
  });

  const csvString=csvRows.join('\n');
  let blob;
  if(encoding==='windows-1251'){
    const encoder=new TextEncoder();
    const utf8=encoder.encode(csvString);
    blob=new Blob([utf8],{type:'text/csv;charset=windows-1251'});
  }else{
    blob=new Blob(['\uFEFF'+csvString],{type:'text/csv;charset=utf-8'});
  }

  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`orders_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  log(`üìÑ –≠–∫—Å–ø–æ—Ä—Ç CSV (${encoding})`);
}

function exportJSON(){
  const json=JSON.stringify(rows,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`orders_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  log(`üìã –≠–∫—Å–ø–æ—Ä—Ç JSON`);
}

document.getElementById('exportCsvBtn').addEventListener('click',exportCSV);
document.getElementById('exportJsonBtn').addEventListener('click',exportJSON);

/* =========================================================== OCR =========================================================== */
const EXT_OK=/\.(jpg|jpeg|png|webp|bmp|gif|tif|tiff|heic)$/i;
function isImageFile(f){return(f.type&&f.type.startsWith("image/"))||EXT_OK.test(f.name);}

function setFiles(list){
  const arr=Array.from(list||[]);
  filesList=arr.filter(isImageFile);
  rows=[];
  renderVirtualTable();
  processedBlobs.clear();
  els.sidePanel.classList.add('hidden');
  prog(0);
  els.runBtn.disabled=filesList.length===0;
  els.reparseBtn.disabled=true;
  els.saveBtn.disabled=true;
  els.dedupeBtn.disabled=true;
  els.analyticsBtn.disabled=true;
  els.exportMenuBtn.disabled=true;
  updateStats();
  log(`üìÅ –ü—Ä–∏–Ω—è—Ç–æ —Ñ–∞–π–ª–æ–≤: ${filesList.length}`);
}

els.fileInput.addEventListener("change",e=>setFiles(e.target.files));
els.dirInput.addEventListener("change",e=>setFiles(e.target.files));

const dropZone=document.getElementById("dropZone");
dropZone.addEventListener("dragover",e=>{e.preventDefault();dropZone.classList.add("dragover");});
dropZone.addEventListener("dragleave",()=>dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop",e=>{e.preventDefault();dropZone.classList.remove("dragover");setFiles(e.dataTransfer.files);});

async function createWorkerSafe(){
  setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ OCR...");
  setProgressLabel("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Tesseract...");
  log("üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ rus+eng...");
  const worker=await Tesseract.createWorker("rus+eng",1,{
    langPath:"https://tessdata.projectnaptha.com/4.0.0",
    logger:m=>{
      if(m.status==='loading language')setProgressLabel(`–Ø–∑—ã–∫: ${Math.round(m.progress*100)}%`);
      else if(m.status==='initializing api')setProgressLabel(`API: ${Math.round(m.progress*100)}%`);
    }
  });
  setProgressLabel("");
  return worker;
}

async function recognizeWithFallback(worker,blob){
  const base=await worker.recognize(blob,{tessedit_pageseg_mode:"6"});
  let text=base?.data?.text||"";
  if(!parsePhones(text)){
    try{
      const cfg={tessedit_pageseg_mode:"6",tessedit_char_whitelist:"+() -0123456789"};
      const phonePass=await worker.recognize(blob,cfg);
      const p=parsePhones(phonePass?.data?.text||"");
      if(p)text=(text+"\n"+p).trim();
    }catch(e){}
  }
  return text;
}

async function runOCR(){
  if(typeof Tesseract==="undefined"){alert("Tesseract –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");return;}
  if(!filesList.length){alert("–î–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");return;}

  els.runBtn.disabled=true;
  els.reparseBtn.disabled=true;
  els.saveBtn.disabled=true;
  els.cancelBtn.disabled=false;
  rows=[];
  renderVirtualTable();
  prog(1);
  setStatus("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...");
  els.log.textContent="";
  processedBlobs.clear();
  els.sidePanel.classList.add('hidden');

  cancelFlag=false;
  let processed=0;
  const total=filesList.length;
  const conc=2;
  const startTime=Date.now();

  log(`üè¢ v4.0 Enterprise: —à–∞–±–ª–æ–Ω—ã, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞`);
  log(`–§–∞–π–ª–æ–≤: ${total}, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å: ${conc}`);

  const workers=[];
  try{
    for(let i=0;i<conc;i++)workers.push(await createWorkerSafe());
    log(`‚úÖ –í–æ—Ä–∫–µ—Ä–æ–≤: ${workers.length}`);
  }catch(e){
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —è–∑—ã–∫–æ–≤");
    setStatus("–û—à–∏–±–∫–∞");
    els.runBtn.disabled=false;
    els.cancelBtn.disabled=true;
    return;
  }

  const priorityTasks=filesList.slice(0,5).map((file,idx)=>({file,idx,priority:true}));
  const backgroundTasks=filesList.slice(5).map((file,idx)=>({file,idx:idx+5,priority:false}));
  const tasks=[...priorityTasks,...backgroundTasks];
  const results=new Array(total);

  async function processTask(worker,task){
    if(cancelFlag)return;
    const{file,idx,priority}=task;
    try{
      setStatus(`${priority?'‚ö°':'üì¶'} –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞: ${idx+1}/${total}`);
      const blob=await preprocessToBlob(file);
      const blobURL=URL.createObjectURL(blob);
      processedBlobs.set(file.name,blobURL);

      setStatus(`${priority?'‚ö°':'üì¶'} OCR: ${idx+1}/${total}`);
      const txt=await recognizeWithFallback(worker,blob);

      const row=parseOrder(txt,file.name);
      results[idx]=row;
      addRowToTable(row);
    }catch(err){
      results[idx]={"–§–∞–π–ª":file.name,"–§–ò–û":"","–¢–µ–ª–µ—Ñ–æ–Ω":"","–†–µ–≥–∏–æ–Ω":"","–ì–æ—Ä–æ–¥":"","–£–ª–∏—Ü–∞":"","–î–æ–º/–ö–≤":"","–ê–¥—Ä–µ—Å (–ø–æ–ª–Ω—ã–π)":"","Raw OCR":"–û—à–∏–±–∫–∞: "+(err.message||err)};
      log(`‚ùå ${file.name}: ${err.message}`);
    }finally{
      processed++;
      prog(Math.round((processed/total)*100));
      const elapsed=((Date.now()-startTime)/1000).toFixed(1);
      const speed=(processed/(Date.now()-startTime)*1000*60).toFixed(1);
      setStatus(`–ì–æ—Ç–æ–≤–æ: ${processed}/${total}`);
      els.statSpeed.textContent=`${speed} —Ñ/–º`;
      updateStats();
    }
  }

  let cursor=0;
  async function workerLoop(worker){
    while(!cancelFlag&&cursor<tasks.length){
      const myTask=tasks[cursor++];
      await processTask(worker,myTask);
    }
  }

  await Promise.all(workers.map(w=>workerLoop(w))).catch(()=>{});
  for(const w of workers){try{await w.terminate();}catch(e){}}

  if(cancelFlag){
    setStatus("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    log("‚è∏Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
    els.runBtn.disabled=false;
    els.cancelBtn.disabled=true;
    return;
  }

  rows=results.filter(Boolean);
  renderVirtualTable();

  const totalTime=((Date.now()-startTime)/1000).toFixed(1);
  setStatus(`‚úÖ –ì–æ—Ç–æ–≤–æ –∑–∞ ${totalTime}s`);
  log(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${rows.length} —Ñ–∞–π–ª–æ–≤ –∑–∞ ${totalTime}s`);

  await saveSession();

  els.saveBtn.disabled=false;
  els.reparseBtn.disabled=false;
  els.analyticsBtn.disabled=false;
  els.dedupeBtn.disabled=false;
  els.exportMenuBtn.disabled=false;
  els.runBtn.disabled=false;
  els.cancelBtn.disabled=true;
  updateStats();
}

els.runBtn.addEventListener("click",runOCR);
els.cancelBtn.addEventListener("click",()=>{cancelFlag=true;els.cancelBtn.disabled=true;});

/* =========================================================== –ü–ï–†–ï–ü–ê–†–°–ò–ù–ì =========================================================== */
els.reparseBtn.addEventListener("click",()=>{
  if(rows.length===0)return;
  log("üîÑ –ü–µ—Ä–µ–ø–∞—Ä—Å–∏–Ω–≥...");
  setStatus("–ü–µ—Ä–µ–ø–∞—Ä—Å–∏–Ω–≥...");
  rows=rows.map(r=>parseOrder(r["Raw OCR"]||"",r["–§–∞–π–ª"]||""));
  renderVirtualTable();
  setStatus("‚úÖ –ü–µ—Ä–µ–ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω");
  log(`‚úÖ –ü–µ—Ä–µ–ø–∞—Ä—Å–µ–Ω–æ: ${rows.length}`);
});

/* =========================================================== –¢–ê–ë–õ–ò–¶–ê =========================================================== */
function syncRowsFromTable(){
  document.querySelectorAll("#preview tbody tr").forEach(tr=>{
    const idx=parseInt(tr.dataset.index);
    if(idx>=0&&idx<rows.length){
      const tds=tr.querySelectorAll("td");
      COLS.forEach((k,i)=>{if(tds[i])rows[idx][k]=tds[i].textContent.trim();});
    }
  });
}

document.getElementById('clearColBtn').addEventListener("click",()=>{
  const idx=document.getElementById('colSelect').selectedIndex;
  if(idx===0){alert("–°—Ç–æ–ª–±–µ—Ü –§–∞–π–ª –æ—á–∏—â–∞—Ç—å –Ω–µ–ª—å–∑—è");return;}
  rows.forEach(r=>r[COLS[idx]]="");
  renderVirtualTable();
});

document.getElementById('fillDownBtn').addEventListener("click",()=>{
  const idx=document.getElementById('colSelect').selectedIndex;
  if(idx===0){alert("–°—Ç–æ–ª–±–µ—Ü –§–∞–π–ª –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–∏–∑ –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞");return;}
  if(rows.length<2)return;
  const base=rows[0][COLS[idx]];
  const val=base||prompt("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ:","");
  if(val===null)return;
  for(let i=1;i<rows.length;i++)rows[i][COLS[idx]]=val;
  renderVirtualTable();
});

els.previewBody.addEventListener("input",()=>syncRowsFromTable());

/* =========================================================== –ü–†–ï–í–¨–Æ =========================================================== */
function showPreview(rowIndex){
  const row=rows[rowIndex];
  if(!row)return;
  const filename=row["–§–∞–π–ª"];
  const blobURL=processedBlobs.get(filename);
  if(!blobURL){els.sidePanel.classList.add("hidden");return;}

  els.sidePanel.classList.remove("hidden");
  els.previewImg.src=blobURL;
  els.previewData.innerHTML=`
    <dt>–§–∞–π–ª:</dt><dd>${filename}</dd>
    <dt>–§–ò–û:</dt><dd>${row["–§–ò–û"]||"<–ø—É—Å—Ç–æ>"}</dd>
    <dt>–¢–µ–ª–µ—Ñ–æ–Ω:</dt><dd>${row["–¢–µ–ª–µ—Ñ–æ–Ω"]||"<–ø—É—Å—Ç–æ>"}</dd>
    <dt>–†–µ–≥–∏–æ–Ω:</dt><dd>${row["–†–µ–≥–∏–æ–Ω"]||"<–ø—É—Å—Ç–æ>"}</dd>
    <dt>–ì–æ—Ä–æ–¥:</dt><dd>${row["–ì–æ—Ä–æ–¥"]||"<–ø—É—Å—Ç–æ>"}</dd>
    <dt>–£–ª–∏—Ü–∞:</dt><dd>${row["–£–ª–∏—Ü–∞"]||"<–ø—É—Å—Ç–æ>"}</dd>
    <dt>–î–æ–º/–ö–≤:</dt><dd>${row["–î–æ–º/–ö–≤"]||"<–ø—É—Å—Ç–æ>"}</dd>
    <dt>Raw OCR:</dt><dd style="font-size:11px; max-height:100px; overflow:auto;">${row["Raw OCR"]?.substring(0,300)||"<–ø—É—Å—Ç–æ>"}</dd>
  `;

  document.querySelectorAll("#preview tbody tr").forEach((tr,idx)=>{
    const trIndex=parseInt(tr.dataset.index);
    tr.classList.toggle("selected",trIndex===rowIndex);
  });

  document.getElementById('previewTab').style.display='block';
  document.getElementById('analyticsTab').style.display='none';
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="preview"]').classList.add('active');
}

/* =========================================================== EXCEL =========================================================== */
function saveExcel(){
  syncRowsFromTable();
  if(!rows.length){alert("–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å");return;}
  const ws=XLSX.utils.json_to_sheet(rows,{header:COLS});
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Orders");
  const timestamp=new Date().toISOString().slice(0,19).replace(/:/g,"-");
  XLSX.writeFile(wb,`orders_v4_${timestamp}.xlsx`);
  log(`üíæ Excel: orders_v4_${timestamp}.xlsx`);
}

els.saveBtn.addEventListener("click",saveExcel);

/* =========================================================== INIT =========================================================== */
(async()=>{
  await db.init();
  updateStats();
  log("üè¢ OCR v4.0 Enterprise –∑–∞–≥—Ä—É–∂–µ–Ω");
  log("‚ú® –®–∞–±–ª–æ–Ω—ã, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, CSV/JSON, –∏—Å—Ç–æ—Ä–∏—è");
  log("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∏ –Ω–∞–∂–º–∏—Ç–µ '–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å'");
})();

setInterval(updateStats,5000);
</script>
</body>
</html>
